<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="icon" type="image/png" href="../assets/images/index/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --bg:#0b0b0f; --panel:rgba(255,255,255,0.03); --muted:#94a3b8; --accent:#7c3aed; }
    html,body{height:100%;margin:0;font-family:"Manrope",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{
      background:
        radial-gradient(circle at 30% 40%, rgba(100,0,180,0.18), transparent 35%),
        radial-gradient(circle at 60% 60%, rgba(150,0,200,0.18), transparent 35%),
        var(--bg);
      color:#e6eef8; display:flex; overflow:hidden;
    }
    .logout-btn-container a {
      display: flex; align-items: center; gap: 0.7rem;
      padding: 0.55rem 0.85rem;
      background: linear-gradient(90deg, #dc2626 60%, #7c3aed 100%);
      color: #fff; border-radius: 12px; font-weight: 600;
      box-shadow: 0 2px 8px rgba(220,38,38,0.15);
      transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
      border: none; cursor: pointer; text-decoration: none; letter-spacing: 0.03em;
      position: relative; overflow: hidden;
    }
    .logout-btn-container a i {
      background: rgba(255,255,255,0.12);
      padding: 0.4rem; border-radius: 8px; font-size: 1.1rem;
      transition: background 0.2s;
    }
    .logout-btn-container a:hover {
      background: linear-gradient(90deg, #ef4444 60%, #a78bfa 100%);
      box-shadow: 0 4px 16px rgba(220,38,38,0.22);
      transform: translateY(-2px) scale(1.03);
    }
    .logout-btn-container a:active { transform: scale(0.98); }
    .sidebar{width:260px;flex-shrink:0;background:var(--panel);display:flex;flex-direction:column;padding:1.2rem;border-right:1px solid rgba(255,255,255,0.1);transform:translateX(-100%);transition:transform 0.3s ease-in-out;z-index:20;height:100vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--muted) var(--panel);}
    .sidebar.open{transform:translateX(0);}
    @media (min-width:768px){.sidebar{transform:translateX(0);}}
    .logo{color:#fff;font-size:1.2rem;font-weight:bold;display:flex;align-items:center;margin-bottom:2rem;}
    .logo i{background:var(--accent);padding:0.4rem;border-radius:8px;margin-right:0.5rem;}
    .nav a{display:flex;align-items:center;gap:1rem;padding:0.75rem 1rem;color:var(--muted);border-radius:12px;text-decoration:none;transition:all 0.2s ease-in-out;}
    .nav a.active,.nav a:hover{background:var(--accent);color:#fff;}
    .nav a.active i,.nav a:hover i{color:#fff;}
    .nav i{color:rgba(255,255,255,0.4);font-size:1rem;}
    .logout-btn-container{margin-top:auto;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.1);}
    .logout-btn-container a{background-color:#dc2626;color:#fff;justify-content:center;text-align:center;}
    .logout-btn-container a:hover{background-color:#ef4444;}
    .container{flex-grow:1;overflow-y:auto;padding:2rem;scrollbar-width:none;-ms-overflow-style:none;}
    .container::-webkit-scrollbar{display:none;}
    .card{background:var(--panel);backdrop-filter:blur(10px);border-radius:16px;padding:2rem;border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 32px 0 rgba(0,0,0,0.37);}
    header{background:var(--panel);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.1);padding:0.75rem 2rem;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:10;}
    .profile-dropdown{position:relative;display:inline-block;}
    .profile-dropdown .dropdown-menu{display:none;position:absolute;right:0;top:100%;margin-top:0.5rem;background:var(--panel);border-radius:8px;min-width:180px;box-shadow:0 4px 12px rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);padding:0.5rem;z-index:20;}
    .profile-dropdown .dropdown-menu.open{display:block;}
    .dropdown-menu .menu-link{display:block;padding:0.5rem 1rem;border-radius:6px;color:#fff;text-decoration:none;}
    .dropdown-menu .menu-link:hover{background:rgba(255,255,255,0.1);}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:50;}
    .modal-content{background:var(--panel);padding:2rem;border-radius:12px;width:90%;max-width:500px;position:relative;}
    .modal-close-btn{position:absolute;top:1rem;right:1rem;color:var(--muted);cursor:pointer;}
    .menu-toggle{display:block;margin-right:1rem;color:#fff;font-size:1.5rem;}
    @media(min-width:768px){.menu-toggle{display:none;}}
    .bell-shake{animation:shake 0.82s cubic-bezier(.36,.07,.19,.97) both;transform:translate3d(0,0,0);backface-visibility:hidden;perspective:1000px;}
    @keyframes shake{10%,90%{transform:translate3d(-1px,0,0);}20%,80%{transform:translate3d(2px,0,0);}30%,50%,70%{transform:translate3d(-4px,0,0);}40%,60%{transform:translate3d(4px,0,0);}}
  </style>
</head>

<body>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><i class="fas fa-cubes"></i><span>RemoteTeamPro</span></div>
    <nav class="nav space-y-2">
      <a href="#dashboard" data-section="dashboard" class="active"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
      <a href="#profile" data-section="profile"><i class="fas fa-user-circle"></i><span>Profile</span></a>
      <a href="#admin-users" data-section="admin-users"><i class="fas fa-users"></i><span>Users</span></a>
      <a href="#companies" data-section="companies"><i class="fas fa-building"></i><span>Companies</span></a>
      <a href="#projects" data-section="projects"><i class="fas fa-project-diagram"></i><span>Projects</span></a>
      <a href="#tasks" data-section="tasks"><i class="fas fa-tasks"></i><span>Tasks</span></a>
      <a href="#admin-timesheets" data-section="admin-timesheets"><i class="fas fa-clock"></i><span>Timesheets</span></a>
      <a href="#attendance" data-section="admin-attendance"><i class="fas fa-calendar-check"></i><span>Attendance</span></a>
      <a href="#messages" data-section="messages"><i class="fas fa-comments"></i><span>Messages</span></a>
      <a href="#reports" data-section="reports-admin"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
      <a href="#client-requests" data-section="client-requests"><i class="fas fa-envelope"></i><span>Client Requests</span></a>
      <a href="#settings" data-section="settings"><i class="fas fa-cogs"></i><span>Settings</span></a>
      <a href="#contact-requests" data-section="contact-requests"><i class="fas fa-envelope"></i><span>Contact Requests</span></a>
            <a href="#admin-activity-log" data-section="admin-activity-log"><i class="fas fa-compass"></i><span>Activity Log</span></a>

    </nav>
    <div class="logout-btn-container">
      <a href="#" data-section="logout" id="logoutButton"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
    </div>
  </aside>

  <div class="flex flex-col flex-1">
    <header>
      <button id="menuToggle" class="menu-toggle md:hidden"><i class="fas fa-bars"></i></button>
      <div class="flex-grow"></div>
      
      <div class="profile-dropdown">
        <button id="profileBtn" class="flex items-center gap-2 rounded-full p-1 hover:bg-white hover:bg-opacity-10 transition focus:outline-none" style="background:transparent;border:0;cursor:pointer">
          <img id="profileAvatar" src="/RemoteTeamPro/frontend/assets/images/index/default-profile.png" alt="profile" class="w-9 h-9 rounded-full object-cover">
        </button>
        <div class="dropdown-menu" id="profileMenu">
          <a href="#settings" data-section="settings" class="menu-link">Settings</a>
          <a href="#dashboard" data-section="dashboard" class="menu-link">Dashboard</a>
        </div>
      </div>
    </header>

    <main class="container" id="mainContent">
      <div class="card"><h2 style="margin:0 0 8px 0">Welcome, Admin</h2><p class="small">Use the left menu to navigate â€” modules load dynamically for faster development.</p></div>
    </main>
  </div>

  <div id="modalRoot" style="display:none"></div>
  <div id="notifModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <button id="closeNotifModal" class="modal-close-btn"><i class="fas fa-times"></i></button>
      <h3 class="text-xl font-semibold mb-4">Notifications</h3>
      <div id="notificationsList" class="space-y-4"></div>
    </div>
  </div>

  <!-- Inline JS (same as before, ensures tabs load) -->
  <script>
    // Global helper: fetch API with GET/POST and JSON
    window.apiFetch = async function(url, method = 'GET', body = null) {
      let opts = { method };
      if (method === 'POST') {
        opts.headers = { 'Content-Type': 'application/json' };
        opts.body = JSON.stringify(body);
      }
      const res = await fetch(url, opts);
      // If not 2xx, return error object
      if (!res.ok) {
        return { error: true, status: res.status, message: `HTTP ${res.status}` };
      }
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        return { error: true, message: 'Invalid JSON', raw: text };
      }
    };

    // Global modal helpers
    window.showModal = function(html) {
      let modalRoot = document.getElementById('modalRoot');
      if (!modalRoot) {
        modalRoot = document.createElement('div');
        modalRoot.id = 'modalRoot';
        document.body.appendChild(modalRoot);
      }
      modalRoot.innerHTML = html;
      modalRoot.style.display = 'block';
    };
    window.closeModal = function() {
      let modalRoot = document.getElementById('modalRoot');
      if (modalRoot) {
        modalRoot.innerHTML = '';
        modalRoot.style.display = 'none';
      }
    };
    const includesPath = 'includes';
    const mainContent = document.getElementById('mainContent');
    const notifBtn = document.getElementById('notifBtn');
    const notifBadge = document.getElementById('notifBadge');
    const notifModal = document.getElementById('notifModal');
    const closeNotifModal = document.getElementById('closeNotifModal');
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.querySelector('.profile-dropdown .dropdown-menu');
    
    // ðŸ”¥ CORRECTED API PATH: Removed the leading `../`
    // Always load from includes folder for all sections
    async function loadContent(section) {
      if (!section) return;
      mainContent.innerHTML = '<div class="card"><div class="animate-pulse text-center text-gray-400">Loading...</div></div>';
      try {
        // Map sidebar section to correct admin include file
        const sectionMap = {
          dashboard: 'admin-dashboard',
          profile: 'admin-profile',
          users: 'admin-users',
          messages: 'admin-messages',
          companies: 'admin-companies',
          projects: 'admin-projects',
          tasks: 'admin-tasks',
          timesheets: 'admin-timesheets',
          attendance: 'admin-attendance',
          reports: 'admin-reports',
          'client-requests': 'admin-client-request',
          settings: 'admin-settings',
          'contact-requests': 'admin-contact-requests',
        };
        const file = sectionMap[section] || section;
        const response = await fetch(`${includesPath}/${file}.html`);
        if (!response.ok) {
          if (response.status === 404) {
            mainContent.innerHTML = `<div class="card"><h2 class="text-red-400">404 - Not Found</h2><p>The requested section <b>'${section}'</b> could not be found. Please check that the file is in the 'includes' directory.</p></div>`;
          } else {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return;
        }
        const html = await response.text();
        // Extract and inject script after DOM update
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const scripts = Array.from(tempDiv.querySelectorAll('script'));
        scripts.forEach(s => s.remove());
        mainContent.innerHTML = tempDiv.innerHTML;
        scripts.forEach(orig => {
          try {
            const newScript = document.createElement('script');
            if (orig.type) newScript.type = orig.type;
            const src = orig.getAttribute('src');
            if (src) {
              newScript.src = src;
              if (orig.async) newScript.async = true;
              if (orig.defer) newScript.defer = true;
              document.body.appendChild(newScript);
            } else {
              newScript.textContent = orig.textContent || '';
              document.body.appendChild(newScript);
            }
          } catch (err) { console.error('Error injecting script from include:', err); }
        });
      } catch (e) {
        mainContent.innerHTML = `<div class="card"><h2 class="text-red-400">Error</h2><p>Failed to load content: ${e.message}.</p></div>`;
        console.error(e);
      }
    }
  // Map section names to schema fields for rendering
  const sectionFields = {
    users: ["user_id", "email", "first_name", "last_name", "role", "status", "created_at"],
    companies: ["company_id", "company_name", "created_at"],
    projects: ["project_id", "project_name", "status", "deadline", "completion_percentage", "budget_allocated", "manager_name", "client_name"],
    attendance: ["attendance_id", "user_id", "date", "check_in_time", "check_out_time", "hours_worked", "status"],
    timesheets: ["timesheet_id", "date", "hours_logged", "status", "description", "task_name", "approved_by"],
    tasks: ["task_id", "task_name", "status", "priority", "due_date", "project_name", "assigned_to_user_name"],
    messages: ["message_id", "sender_id", "recipient_id", "message_content", "sent_at"],
    reports: ["label", "value", "progress"],
    // Add more mappings as needed
  };

  function renderTable(section, data) {
    const fields = sectionFields[section];
    if (!fields || !Array.isArray(data) || !data.length) {
      return `<div class='text-gray-400'>No data found.</div>`;
    }
    let html = `<div class='overflow-x-auto'><table class='min-w-full text-sm'><thead><tr>`;
    fields.forEach(f => {
      html += `<th class='px-2 py-1 border-b border-gray-700 text-left'>${f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`;
    });
    html += `</tr></thead><tbody>`;
    data.forEach(item => {
      html += `<tr>`;
      fields.forEach(f => {
        html += `<td class='px-2 py-1 border-b border-gray-800'>${item[f] !== undefined ? item[f] : ""}</td>`;
      });
      html += `</tr>`;
    });
    html += `</tbody></table></div>`;
    return html;
  }

  // Always load from includes folder for all sections
  // (Removed duplicate loadContent definition)

    function handleLogout() {
      // Clear session via backend API, then redirect
  fetch('/RemoteTeamPro/backend/api/auth/logout.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      })
      .finally(() => {
        window.location.href = './index.html';
      });
    }

    document.querySelector('.sidebar .nav').addEventListener('click', (e) => {
        e.preventDefault();
        const target = e.target.closest('a');
        if (!target) return;

        document.querySelectorAll('.nav a').forEach(link => link.classList.remove('active'));
        target.classList.add('active');

        const section = target.getAttribute('data-section');
        if (section && section !== 'logout') {
            loadContent(section);
        } else if (target.id === 'logoutButton' || section === 'logout') {
            handleLogout();
        }
    });

    profileBtn.addEventListener('click', () => {
        profileDropdown.classList.toggle('open');
    });
    // Removed duplicate sidebar tab click handler to avoid double loading and event conflicts
    // Handle profile dropdown menu clicks
    profileDropdown.addEventListener('click', (e) => {
        e.preventDefault();
        const target = e.target.closest('a.menu-link');
        if (!target) return;
        profileDropdown.classList.remove('open');
        const section = target.getAttribute('data-section');
        if (section) {
            document.querySelectorAll('.nav a').forEach(link => link.classList.remove('active'));
            const navLink = document.querySelector(`.nav a[data-section="${section}"]`);
            if (navLink) navLink.classList.add('active');
            loadContent(section);
        }
    });

    // Handle logout button click in the sidebar
    document.getElementById('logoutButton').addEventListener('click', (e) => {
      e.preventDefault();
      handleLogout();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)) {
            profileDropdown.classList.remove('open');
        }
    });
    
    
    // Initial content load
    document.addEventListener('DOMContentLoaded', () => {
        // Load profile avatar dynamically
        fetch('/RemoteTeamPro/backend/api/profile.php?action=current', { credentials: 'include' })
          .then(res => res.json())
          .then(user => {
            const avatar = document.getElementById('profileAvatar');
            if (avatar) {
              let url = user && user.profile_picture_url ? user.profile_picture_url : '/RemoteTeamPro/frontend/assets/images/index/default-profile.png';
              // Add cache-busting if custom
              if (user && user.profile_picture_url) url += '?t=' + Date.now();
              avatar.src = url;
            }
          });
        loadContent('dashboard');
    });
</script>
        <script src="/RemoteTeamPro/frontend/src/assets/js/notifications.js"></script>
   
</body>
</html>