<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager Team Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    body { background-color: #0d0d1b; color: #e6eef8; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .glass-card { background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
    .status-badge { padding: 6px 12px; border-radius: 999px; font-weight: 700; font-size: 12px; display:inline-block; }
    .custom-scrollbar::-webkit-scrollbar { width: 8px; } 
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 8px; }

    .tab-btn.active { border-bottom: 3px solid #7c3aed; color: #7c3aed; font-weight:700; }
    .modal-backdrop { background: rgba(0,0,0,0.7); }
    .btn { transition: all .12s ease; }
    .btn:disabled { opacity: .5; pointer-events: none; transform: none; }

    /* Dark select (improve contrast) */
    select.dark-select {
      background: #0f1724; /* dark slate */
      color: #e6eef8;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 0.75rem;
      border-radius: 0.5rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    /* Option styles (some browsers ignore these but most modern do apply) */
    select.dark-select option {
      background: #0b1220;
      color: #e6eef8;
    }

    /* Better contrast for dropdown arrow */
    .select-wrapper { position: relative; }
    .select-wrapper:after {
      content: '\f107';
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: rgba(230,238,248,0.7);
    }

    /* Toast simple */
    #toast { transition: opacity .25s ease, transform .2s ease; transform-origin: bottom right; }
  </style>
</head>
<body class="p-6 md:p-10">

  <div class="max-w-7xl mx-auto space-y-8">

    <header>
      <h1 class="text-4xl font-extrabold text-indigo-300">Team Management</h1>
      <p class="text-slate-400 mt-1">Automatically sync teams from assigned project members or create teams manually.</p>
    </header>

    <div class="flex items-center justify-between">
      <div class="flex space-x-3 items-center">
        <button id="tab-project-view" class="tab-btn active px-4 py-2">Project View</button>
        <button id="tab-team-management" class="tab-btn px-4 py-2">Team Management</button>
      </div>

      <div class="flex items-center gap-3">
        <button id="sync-teams-btn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">
          <i class="fa-solid fa-sync mr-2"></i>Sync Teams from Assignments
        </button>
        <button id="open-create-team" class="btn bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow">
          <i class="fa-solid fa-plus mr-2"></i>Create Team
        </button>
      </div>
    </div>

    <div id="loading" class="glass-card p-6 text-center hidden">
      <i class="fa-solid fa-spinner fa-spin text-cyan-400 mr-3"></i>Loading...
    </div>

    <section id="project-view" class="tab-content space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="glass-card p-6">
          <h2 class="font-semibold text-indigo-300">Project</h2>
          <h3 id="pv-project-name" class="text-2xl font-bold mt-2">—</h3>
          <p id="pv-project-desc" class="text-slate-300 mt-2 text-sm">—</p>

          <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="p-3 glass-card">
              <p class="text-xs text-slate-400">Status</p>
              <div id="pv-status" class="mt-2 status-badge bg-slate-600 text-slate-100">—</div>
            </div>
            <div class="p-3 glass-card">
              <p class="text-xs text-slate-400">Completion</p>
              <p id="pv-completion" class="mt-2 text-lg font-bold text-emerald-400">0%</p>
            </div>
            <div class="p-3 glass-card col-span-2">
              <p class="text-xs text-slate-400">Manager</p>
              <p id="pv-manager" class="mt-2 font-medium">—</p>
              <p class="text-xs text-slate-400 mt-2">Client</p>
              <p id="pv-client" class="mt-2 font-medium">—</p>
            </div>
          </div>
        </div>

        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold text-indigo-300">Assigned Teams</h3>
          <div id="pv-team-assignments" class="space-y-3 mt-4">
            <p class="text-slate-400">No teams assigned yet.</p>
          </div>

          <h3 class="text-lg font-semibold text-indigo-300 mt-6">Individual Contributors</h3>
          <div id="pv-user-assignments" class="space-y-2 mt-4 max-h-48 overflow-y-auto custom-scrollbar">
            <p class="text-slate-400">No individuals assigned.</p>
          </div>
        </div>

        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold text-indigo-300">Team / Projects Overview</h3>

          <div id="projectOverviewSummary" class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-4 mb-4 text-sm">
            <div class="bg-slate-800/40 rounded-lg p-3">
              <p class="text-slate-400">Teams</p>
              <p id="overviewTeams" class="text-indigo-400 font-semibold text-lg">0</p>
            </div>
            <div class="bg-slate-800/40 rounded-lg p-3">
              <p class="text-slate-400">Contributors</p>
              <p id="overviewContributors" class="text-indigo-400 font-semibold text-lg">0</p>
            </div>
            <div class="bg-slate-800/40 rounded-lg p-3">
              <p class="text-slate-400">Completion</p>
              <p id="overviewCompletion" class="text-emerald-400 font-semibold text-lg">0%</p>
            </div>
          </div>

          <div id="project-overview-chart-container" class="relative">
            <canvas id="projectOverviewChart" class="w-full h-64"></canvas>
          </div>
        </div>
      </div>

      <div class="glass-card p-6 space-y-4">
        <h3 class="font-semibold text-indigo-300">Assign Team to Project</h3>

        <div class="select-wrapper w-full">
          <select id="select-project" class="dark-select w-full">
            <option value="">Select project...</option>
          </select>
        </div>

        <div class="flex gap-3 items-center">
          <div class="select-wrapper flex-1">
            <select id="assign-team-select" class="dark-select w-full">
              <option value="">Select team...</option>
            </select>
          </div>
          <input id="assign-role" type="text" placeholder="Role on project (optional)" class="flex-1 bg-transparent border border-slate-700 rounded-lg p-3" />
          <button id="assign-team-btn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow" disabled>
            <i class="fa-solid fa-plus mr-2"></i>Assign
          </button>
        </div>
      </div>
    </section>

    <section id="team-management" class="tab-content hidden space-y-6">
      <div class="glass-card p-6">
        <h2 class="text-xl font-semibold text-indigo-300">Company Teams</h2>
        <div id="teams-list" class="mt-4 space-y-3">
          <p class="text-slate-400 text-center py-6">Loading teams...</p>
        </div>
      </div>
      
      </section>
  </div>

  <div id="team-modal" class="modal-backdrop fixed inset-0 hidden z-50 flex items-center justify-center p-4">
    <div class="glass-card w-full max-w-2xl p-6">
      <h3 id="team-modal-title" class="text-xl font-bold text-indigo-300">Create Team</h3>
      <form id="team-form" class="mt-4 space-y-3">
        <input type="hidden" id="team-id" value="" />
        <div>
          <label class="text-sm text-slate-300">Team Name</label>
          <input id="team-name" class="w-full mt-1 p-3 rounded-lg bg-transparent border border-slate-700" required />
        </div>
        <div>
          <label class="text-sm text-slate-300">Description</label>
          <textarea id="team-desc" class="w-full mt-1 p-3 rounded-lg bg-transparent border border-slate-700"></textarea>
        </div>

        <div>
          <label class="text-sm text-slate-300">Available Employees (low-load)</label>
          <div id="team-members-area" class="mt-2 max-h-48 overflow-y-auto custom-scrollbar p-2 border border-slate-700 rounded-lg bg-transparent">
            <p class="text-slate-400">Loading available employees...</p>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-4">
          <button type="button" id="team-cancel" class="bg-slate-600 px-4 py-2 rounded-lg">Cancel</button>
          <button type="submit" id="team-save" class="bg-indigo-600 px-4 py-2 rounded-lg text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="roster-modal" class="modal-backdrop fixed inset-0 hidden z-50 flex items-center justify-center p-4">
    <div class="glass-card w-full max-w-2xl p-6">
      <h3 id="roster-title" class="text-xl font-bold text-indigo-300">Edit Roster</h3>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h4 class="text-sm text-slate-300">Current Members</h4>
          <ul id="roster-current" class="mt-2 max-h-56 overflow-y-auto custom-scrollbar p-2 border border-slate-700 rounded-lg"></ul>
        </div>

        <div>
          <h4 class="text-sm text-slate-300">Available Employees</h4>
          <div id="roster-available" class="mt-2 max-h-56 overflow-y-auto custom-scrollbar p-2 border border-slate-700 rounded-lg"></div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button id="roster-close" class="bg-slate-600 px-4 py-2 rounded-lg">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-6 right-6 opacity-0 pointer-events-none transition-opacity z-50"></div>

<script>
(async ()=> {
  const API = 'http://localhost/RemoteTeamPro/backend/api/manager-teams.php';
  // keep original behavior: project_id from window or url if provided
  let PROJECT_ID = window.PROJECT_ID || (new URLSearchParams(window.location.search).get('project_id') || null);

  // State
  let teams = [];
  let availableUsers = [];
  let projectData = null;
  let projects = []; // all projects (for selector)

  // Charts (Only projectOverviewChart is needed)
  let projectOverviewChart = null; // Used locally for instance management

  // Elements
  const loadingEl = document.getElementById('loading');
  const pvProjectName = document.getElementById('pv-project-name');
  const pvProjectDesc = document.getElementById('pv-project-desc');
  const pvManager = document.getElementById('pv-manager');
  const pvClient = document.getElementById('pv-client');
  const pvCompletion = document.getElementById('pv-completion');
  const pvStatus = document.getElementById('pv-status');
  const pvTeamAssignments = document.getElementById('pv-team-assignments');
  const pvUserAssignments = document.getElementById('pv-user-assignments');

  const assignTeamSelect = document.getElementById('assign-team-select');
  const assignTeamBtn = document.getElementById('assign-team-btn');
  const assignRoleInput = document.getElementById('assign-role');

  const selectProject = document.getElementById('select-project');

  const teamsListEl = document.getElementById('teams-list');

  const teamModal = document.getElementById('team-modal');
  const rosterModal = document.getElementById('roster-modal');

  const teamForm = document.getElementById('team-form');
  const teamMembersArea = document.getElementById('team-members-area');
  const teamNameInput = document.getElementById('team-name');
  const teamDescInput = document.getElementById('team-desc');
  const teamIdInput = document.getElementById('team-id');

  const rosterCurrent = document.getElementById('roster-current');
  const rosterAvailable = document.getElementById('roster-available');

  const toast = document.getElementById('toast');
  
  // Project View Chart Container
  const projectOverviewContainer = document.getElementById('project-overview-chart-container');

  function showLoading(flag=true) { loadingEl.classList.toggle('hidden', !flag); }
  function showToast(msg, ok=true) {
    toast.textContent = msg;
    toast.className = `fixed bottom-6 right-6 p-3 rounded shadow ${ok ? 'bg-emerald-600' : 'bg-red-600'} text-white opacity-100`;
    setTimeout(()=> { toast.className = ''; toast.textContent = ''; }, 3000);
  }

  function getStatusClass(status) {
    if (!status) return 'bg-slate-600 text-slate-100';
    const s = status.toLowerCase();
    if (s === 'active' || s === 'running') return 'bg-emerald-600 text-white';
    if (s === 'on hold' || s === 'paused') return 'bg-yellow-600 text-slate-900';
    if (s === 'completed' || s === 'finished') return 'bg-indigo-600 text-white';
    if (s === 'cancelled' || s === 'failed') return 'bg-red-600 text-white';
    return 'bg-slate-600 text-slate-100';
  }

  async function safeFetch(payload = {}, method='GET') {
    const hasQuery = (method === 'GET' && payload.action);
    const q = Object.keys(payload).map(k => `${encodeURIComponent(k)}=${encodeURIComponent(payload[k])}`).join('&');
    const url = API + (hasQuery ? `?${q}` : '');
    const opts = { method, credentials: 'include' };
    if (method !== 'GET') {
      opts.headers = { 'Content-Type': 'application/json' };
      opts.body = JSON.stringify(payload);
    }
    const r = await fetch(url, opts);
    let j = {};
    try { j = await r.json(); } catch(e){ throw new Error('Invalid JSON response'); }
    if (!r.ok || !j.success) throw new Error(j.error || j.message || 'Unknown API error');
    return j;
  }
  
  // ensure Chart is loaded before creating charts (prevents ReferenceError)
  function ensureChartReady(timeoutMs = 3000) {
    return new Promise((resolve, reject) => {
      if (typeof Chart !== 'undefined') return resolve();
      const start = Date.now();
      const interval = setInterval(() => {
        if (typeof Chart !== 'undefined') {
          clearInterval(interval);
          return resolve();
        }
        if (Date.now() - start > timeoutMs) {
          clearInterval(interval);
          return reject(new Error('Chart.js not loaded'));
        }
      }, 50);
    });
  }

  // Loaders
  async function syncTeamsFromAssignments() {
    showLoading(true);
    try {
      await safeFetch({ action: 'SYNC_TEAMS_FROM_ASSIGNMENTS' }, 'POST');
      showToast('Teams synced.');
      await loadAll();
    } catch (e) {
      showToast('Sync failed: '+e.message, false);
    } finally {
      showLoading(false);
    }
  }

  async function loadAll() {
    showLoading(true);
    try {
      await Promise.allSettled([loadTeams(), loadAvailableUsers(), loadAllProjects()]);

      if (PROJECT_ID) {
        const found = projects.find(p => String(p.project_id) === String(PROJECT_ID));
        if (found) selectProject.value = String(PROJECT_ID);
      }

      await loadProjectData(PROJECT_ID);
      await renderAll();
    } catch (e) {
      console.error(e);
      showToast('Load failed: '+(e.message||e), false);
    } finally {
      showLoading(false);
    }
  }

  async function loadProjectData(pid = PROJECT_ID) {
    if (!pid) {
        try {
            const resp = await safeFetch({ action: 'GET_OVERALL_SUMMARY' }, 'GET');
            
            projectData = {
                isOverall: true,
                project_name: 'All Projects Overview',
                description: `Summary across ${resp.summary.total_projects} projects you manage.`,
                status: 'Active', 
                manager_name: 'N/A', 
                client_name: 'N/A',
                completion_percentage: resp.summary.avg_completion,
                team_assignments: resp.summary.total_teams, 
                user_assignments: resp.summary.total_users, 
            };
        } catch (e) {
            console.warn('Overall summary load failed (non-fatal):', e.message);
            projectData = null; 
        }
        return; 
    }

    try {
        const resp = await safeFetch({ action: 'GET_PROJECT_DATA', project_id: pid }, 'GET');
        projectData = resp.project || null; 
        if (projectData) {
            projectData.isOverall = false; 
            projectData.team_assignments = resp.team_assignments || [];
            projectData.user_assignments = resp.user_assignments || [];
        } else {
            projectData = null;
        }
    } catch (e) {
        console.warn('Project load failed (non-fatal):', e.message);
        projectData = null;
    }
  }

  async function loadTeams() {
    try {
      const resp = await safeFetch({ action: 'GET_ALL_TEAMS' }, 'GET');
      teams = resp.teams || [];
    } catch (e) {
      console.warn('Load teams failed:', e.message);
      teams = [];
    }
  }

  async function loadAvailableUsers() {
    try {
      const resp = await safeFetch({ action: 'LIST_AVAILABLE_EMPLOYEES' }, 'GET');
      availableUsers = resp.employees || [];
    } catch (e) {
      console.warn('Load users failed:', e.message);
      availableUsers = [];
    }
  }

  async function loadAllProjects() {
    try {
      const resp = await safeFetch({ action: 'GET_ALL_PROJECTS' }, 'GET');
      projects = resp.projects || [];
      selectProject.innerHTML = '<option value="">Select project...</option>';
      projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.project_id;
        opt.textContent = p.project_name + (p.status ? ` — ${p.status}` : '');
        selectProject.appendChild(opt);
      });
      return projects;
    } catch (e) {
      console.warn('Load projects failed:', e.message);
      selectProject.innerHTML = '<option value="">(Failed to load projects)</option>';
      projects = [];
    }
  }

  // Renderers
  function renderProjectView() {
    if (!projectData || Object.keys(projectData).length === 0) {
      pvProjectName.textContent = '—';
      pvProjectDesc.textContent = 'Please select a project from the dropdown below or check the server logs if this state persists.';
      pvManager.textContent = 'N/A';
      pvClient.textContent = 'N/A';
      pvCompletion.textContent = '0.00%';
      pvStatus.textContent = 'N/A';
      pvStatus.className = 'status-badge bg-slate-600 text-slate-100';
      pvTeamAssignments.innerHTML = '<p class="text-slate-400">No data loaded.</p>';
      pvUserAssignments.innerHTML = '<p class="text-slate-400">No data loaded.</p>';
      
      document.getElementById('overviewTeams').textContent = '0';
      document.getElementById('overviewContributors').textContent = '0';
      document.getElementById('overviewCompletion').textContent = '0%';

      assignTeamBtn.disabled = true;
      return; 
    }

    assignTeamBtn.disabled = projectData.isOverall;

    pvProjectName.textContent = projectData.project_name || 'Unnamed Project';
    pvProjectDesc.textContent = projectData.description || 'N/A';
    pvManager.textContent = projectData.manager_name || 'N/A';
    pvClient.textContent = projectData.client_name || 'N/A';
    
    const completion = parseFloat(projectData.completion_percentage || 0);
    pvCompletion.textContent = `${completion.toFixed(2)}%`;

    const statusText = projectData.status || 'N/A';
    pvStatus.textContent = statusText;
    pvStatus.className = 'status-badge ' + getStatusClass(statusText);


    if (projectData.isOverall) {
        pvTeamAssignments.innerHTML = `
            <div class="glass-card p-3 bg-slate-800/60">
                <p class="text-sm text-slate-400">Total Unique Teams Assigned</p>
                <p class="text-2xl font-bold text-indigo-400 mt-1">${projectData.team_assignments}</p>
            </div>
        `;
        pvUserAssignments.innerHTML = `
            <div class="glass-card p-3 bg-slate-800/60">
                <p class="text-sm text-slate-400">Total Unique Contributors</p>
                <p class="text-2xl font-bold text-indigo-400 mt-1">${projectData.user_assignments}</p>
            </div>
        `;
        
        document.getElementById('overviewTeams').textContent = projectData.team_assignments;
        document.getElementById('overviewContributors').textContent = projectData.user_assignments;
        document.getElementById('overviewCompletion').textContent = completion.toFixed(2) + '%';
        
    } else {
        if (!projectData.team_assignments || projectData.team_assignments.length === 0) {
            pvTeamAssignments.innerHTML = '<p class="text-slate-400">No teams assigned yet.</p>';
        } else {
            pvTeamAssignments.innerHTML = projectData.team_assignments.map(t => `
                <div class="glass-card p-3 flex items-center justify-between">
                    <div>
                        <div class="font-semibold text-indigo-200">${escapeHtml(t.team_name)}</div>
                        <div class="text-xs text-slate-400">${escapeHtml(t.role_on_project || 'Contributor')}</div>
                    </div>
                    <div class="text-xs text-slate-500">${t.member_count || 0} members</div>
                </div>
            `).join('');
        }
        
        if (!projectData.user_assignments || projectData.user_assignments.length === 0) {
            pvUserAssignments.innerHTML = '<p class="text-slate-400">No individual contributors.</p>';
        } else {
            pvUserAssignments.innerHTML = projectData.user_assignments.map(u => `
                <div class="flex items-center justify-between p-2 rounded bg-slate-800">
                    <div><strong>${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)}</strong><div class="text-xs text-slate-400">${escapeHtml(u.role_on_project || 'Contributor')}</div></div>
                    <div class="text-xs text-slate-400">${escapeHtml(u.email || '')}</div>
                </div>
            `).join('');
        }
        
        document.getElementById('overviewTeams').textContent = (projectData.team_assignments || []).length;
        document.getElementById('overviewContributors').textContent = (projectData.user_assignments || []).length;
        document.getElementById('overviewCompletion').textContent = completion.toFixed(2) + '%';
    }
    
    populateAssignDropdown();
  }

  function renderTeamsList() {
    if (!teams || teams.length === 0) {
      teamsListEl.innerHTML = '<p class="text-slate-400 text-center py-6">No teams found.</p>';
      return;
    }
    teamsListEl.innerHTML = teams.map(team => {
      const projectNames = (team.projects || []).map(p => p.project_name).join(', ') || 'No linked project';
      return `
        <div class="glass-card p-4 flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold text-indigo-200">${escapeHtml(team.team_name)}</div>
            <div class="text-sm text-slate-400 mt-1">${escapeHtml(team.description || '—')}</div>
            <div class="text-xs text-slate-500 mt-2">Manager: ${escapeHtml(team.manager_name || '')} • Members: ${team.member_count || 0}</div>
            <div class="text-xs text-slate-500 mt-1">Projects: ${escapeHtml(projectNames)}</div>
          </div>
          <div class="flex gap-2">
            <button data-id="${team.team_id}" class="btn view-roster bg-indigo-600 px-3 py-2 rounded text-white"><i class="fa-solid fa-users-gear"></i></button>
            <button data-id="${team.team_id}" class="btn edit-team bg-yellow-600 px-3 py-2 rounded text-white"><i class="fa-solid fa-edit"></i></button>
            <button data-id="${team.team_id}" class="btn delete-team bg-red-600 px-3 py-2 rounded text-white"><i class="fa-solid fa-trash-alt"></i></button>
          </div>
        </div>
      `;
    }).join('');

    document.querySelectorAll('.view-roster').forEach(b => b.addEventListener('click', (e) => openRosterModal(e.currentTarget.dataset.id)));
    document.querySelectorAll('.edit-team').forEach(b => b.addEventListener('click', (e) => openCreateTeamModal(e.currentTarget.dataset.id)));
    document.querySelectorAll('.delete-team').forEach(b => b.addEventListener('click', (e) => deleteTeam(e.currentTarget.dataset.id)));
  }

  function renderAvailableUsersCheckboxes(currentMembers = []) {
    if (!availableUsers || availableUsers.length === 0) {
      teamMembersArea.innerHTML = '<p class="text-slate-400">No employees available.</p>';
      return;
    }
    teamMembersArea.innerHTML = availableUsers.map(u => `
      <div class="flex items-center space-x-2 p-1">
        <input type="checkbox" id="user-${u.user_id}" name="member" value="${u.user_id}" ${currentMembers.includes(u.user_id) ? 'checked' : ''} class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500">
        <label for="user-${u.user_id}" class="text-sm text-slate-300">${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)} (${escapeHtml(u.role)})</label>
      </div>
    `).join('');
  }

  function populateAssignDropdown() {
    assignTeamSelect.innerHTML = '<option value="">Select team...</option>';
    teams.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.team_id;
      opt.textContent = t.team_name;
      assignTeamSelect.appendChild(opt);
    });

    const projectSelected = selectProject.value !== '';
    const teamSelected = assignTeamSelect.value !== '';

    assignTeamBtn.disabled = !projectSelected || !teamSelected || projectData.isOverall;
  }
  
  // === Project Overview Chart (Ensures robust display/replacement) ===
  async function renderProjectOverviewChart() {
    await ensureChartReady().catch(() => { console.warn('Chart.js not ready — skipping project overview chart'); return; });
    
    // 1. Destroy previous chart instance if it exists
    if (projectOverviewChart) {
      try { projectOverviewChart.destroy(); } catch (e) { /* ignore */ }
      projectOverviewChart = null;
    }
    
    // Clear the container content
    projectOverviewContainer.innerHTML = '';

    if (!projectData || Object.keys(projectData).length === 0 || (!PROJECT_ID && !projectData.isOverall)) {
      // Data is NOT present or failed load
      const messageEl = document.createElement('p');
      messageEl.className = 'text-slate-400 text-center py-6';
      messageEl.textContent = 'Select a project to view overview.';
      projectOverviewContainer.appendChild(messageEl);
      return;
    } 
    
    // Data IS present

    const teamCount = projectData.isOverall ? projectData.team_assignments : (projectData.team_assignments || []).length;
    const contributorCount = projectData.isOverall ? projectData.user_assignments : (projectData.user_assignments || []).length;
    const completion = parseFloat(projectData.completion_percentage || 0);

    // 2. Re-create and insert the canvas element
    const canvas = document.createElement('canvas');
    canvas.id = 'projectOverviewChart';
    canvas.className = 'w-full h-64'; // Set height here for Chart.js
    projectOverviewContainer.appendChild(canvas);

    // 3. Draw the chart
    const ctx = canvas.getContext('2d');

    const labels = ['Teams Assigned', 'Contributors', 'Completion %'];
    const dataValues = [teamCount, contributorCount, completion];

    try {
      projectOverviewChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: projectData.isOverall ? 'Total Metrics' : 'Project Metrics',
            data: dataValues,
            backgroundColor: ['#7c3aed', '#06b6d4', '#10b981'], // Indigo, Cyan, Emerald
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, 
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              ticks: { color: '#cbd5e1' },
              grid: { color: 'rgba(255,255,255,0.03)' }
            },
            y: {
              beginAtZero: true,
              max: Math.max(Math.ceil(dataValues[0]), Math.ceil(dataValues[1]), 100),
              ticks: { color: '#cbd5e1' },
              grid: { color: 'rgba(255,255,255,0.03)' }
            }
          }
        }
      });
    } catch (err) {
      console.warn('Project Overview Chart Error:', err.message);
    }
  }


  // Utility to safely escape HTML content
  function escapeHtml(s) { if (s === null || s === undefined) return ''; return String(s).replace(/[&<>\"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"\'":'&#39;'}[m])); }

  async function renderAll() {
    renderProjectView();
    renderTeamsList();
    // Team Management charts removed from here
    await renderProjectOverviewChart(); // Keep Project View chart rendering
    renderAvailableUsersCheckboxes();
  }

  // CRUD Actions
  async function addTeamMember(team_id, user_id) {
    try {
      showLoading(true);
      const resp = await safeFetch({ action: 'ADD_TEAM_MEMBER', team_id, user_id }, 'POST');
      showToast(resp.message || 'Member added');
    } catch (e) {
      showToast('Add failed: '+e.message, false);
    } finally {
      showLoading(false);
    }
  }

  async function removeTeamMember(team_id, user_id) {
    try {
      showLoading(true);
      const resp = await safeFetch({ action: 'REMOVE_TEAM_MEMBER', team_id, user_id }, 'POST');
      showToast(resp.message || 'Member removed');
    } catch (e) {
      showToast('Remove failed: '+e.message, false);
    } finally {
      showLoading(false);
    }
  }
  
  async function deleteTeam(team_id) {
    if (!confirm('Are you sure you want to delete this team and all its assignments?')) return;
    try {
      showLoading(true);
      await safeFetch({ action: 'DELETE_TEAM', team_id }, 'POST');
      showToast('Team deleted');
      await loadAll();
    } catch (e) {
      showToast('Delete failed: '+e.message, false);
    } finally {
      showLoading(false);
    }
  }

  async function assignTeamToProject(team_id, role_on_project, project_id) {
    if (!project_id) { showToast('No project selected for assignment.', false); return; }
    try {
      showLoading(true);
      const resp = await safeFetch({ action: 'ASSIGN_TEAM_TO_PROJECT', project_id: project_id, team_id, role_on_project }, 'POST');
      showToast(resp.message || 'Team assigned to project');
      await loadProjectData(project_id);
      renderProjectView();
      await loadTeams();
      renderTeamsList();
      // Removed Team Management chart calls
      await renderProjectOverviewChart();
    } catch (e) {
      showToast('Assign failed: '+e.message, false);
    } finally {
      showLoading(false);
    }
  }

  // Modals
  async function openCreateTeamModal(teamId = null) {
    teamForm.reset();
    teamIdInput.value = '';
    teamModal.classList.remove('hidden');

    if (teamId) {
      const team = teams.find(t => String(t.team_id) === String(teamId));
      if (!team) { showToast('Team not found.', false); return; }
      
      document.getElementById('team-modal-title').textContent = 'Edit Team: ' + team.team_name;
      teamIdInput.value = team.team_id;
      teamNameInput.value = team.team_name;
      teamDescInput.value = team.description || '';

      try {
        const resp = await safeFetch({ action: 'GET_TEAM_ROSTER', team_id: teamId }, 'GET');
        const currentMembers = (resp.roster || []).map(u => u.user_id);
        renderAvailableUsersCheckboxes(currentMembers);
      } catch (e) {
        renderAvailableUsersCheckboxes();
        console.error('Failed to load roster:', e.message);
      }

    } else {
      document.getElementById('team-modal-title').textContent = 'Create Team';
      teamNameInput.value = `Team – ${projectData && projectData.project_name ? (projectData.isOverall ? 'New' : projectData.project_name) : 'New'}`;
      teamDescInput.value = `Auto or manual team for ${projectData && projectData.project_name ? (projectData.isOverall ? 'All Projects' : projectData.project_name) : 'new project'}`;
      renderAvailableUsersCheckboxes();
    }
  }

  async function openRosterModal(teamId) {
    try {
      showLoading(true);
      const team = teams.find(t => String(t.team_id) === String(teamId));
      if (!team) throw new Error('Team not found');
      document.getElementById('roster-title').textContent = 'Edit Roster: ' + team.team_name;

      const resp = await safeFetch({ action: 'GET_TEAM_ROSTER', team_id: teamId }, 'GET');
      const roster = resp.roster || [];
      const currentIds = roster.map(u => u.user_id);

      rosterCurrent.innerHTML = roster.length ? roster.map(u => `
        <li class="flex justify-between items-center p-2 bg-slate-800 rounded mb-1">
          <span>${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)}</span>
          <button class="remove-member-btn text-red-400" data-team="${teamId}" data-user="${u.user_id}"><i class="fa-solid fa-user-minus"></i></button>
        </li>
      `).join('') : '<li class="text-slate-400 p-2">No members</li>';

      const available = availableUsers.filter(u=>!currentIds.includes(u.user_id));
      rosterAvailable.innerHTML = available.length ? available.map(u => `
        <div class="flex justify-between items-center p-2 bg-slate-800 rounded mb-1">
          <span>${escapeHtml(u.first_name)} ${escapeHtml(u.last_name)} (${escapeHtml(u.role)})</span>
          <button class="add-member-btn text-green-400" data-team="${teamId}" data-user="${u.user_id}"><i class="fa-solid fa-user-plus"></i></button>
        </div>
      `).join('') : '<div class="text-slate-400 p-2">No available users</div>';

      // attach add/remove handlers
      document.querySelectorAll('.add-member-btn').forEach(b => b.addEventListener('click', async (e) => { 
        const team = e.currentTarget.dataset.team, user = e.currentTarget.dataset.user; 
        await addTeamMember(team, user); 
        await openRosterModal(team); 
        await loadTeams(); 
        renderTeamsList();
      }));
      document.querySelectorAll('.remove-member-btn').forEach(b => b.addEventListener('click', async (e) => { 
        const team = e.currentTarget.dataset.team, user = e.currentTarget.dataset.user; 
        await removeTeamMember(team, user); 
        await openRosterModal(team); 
        await loadTeams(); 
        renderTeamsList(); 
      }));

      rosterModal.classList.remove('hidden');
    } catch (e) {
      showToast('Roster load failed: '+e.message, false);
    } finally {
      showLoading(false);
    }
  }


  // Events
  document.getElementById('sync-teams-btn').addEventListener('click', () => syncTeamsFromAssignments());
  document.getElementById('open-create-team').addEventListener('click', () => openCreateTeamModal());
  document.getElementById('team-cancel').addEventListener('click', ()=> teamModal.classList.add('hidden'));
  document.getElementById('roster-close').addEventListener('click', ()=> rosterModal.classList.add('hidden'));

  teamForm.addEventListener('submit', async (e)=> {
    e.preventDefault();
    const tname = teamNameInput.value.trim();
    if (!tname) { showToast('Team name is required.', false); return; }

    const members = Array.from(teamMembersArea.querySelectorAll('input:checked')).map(input => parseInt(input.value));

    const payload = {
      action: 'CREATE_TEAM',
      team_id: teamIdInput.value || null,
      team_name: tname,
      description: teamDescInput.value.trim(),
      members: members
    };
    
    try {
      showLoading(true);
      const resp = await safeFetch(payload, 'POST');
      showToast(resp.message || (payload.team_id ? 'Team updated' : 'Team created'));
      teamModal.classList.add('hidden');
      await loadAll();
    } catch (e) {
      showToast('Save failed: '+e.message, false);
    } finally {
      showLoading(false);
    }
  });

  // Project Selection Change
  selectProject.addEventListener('change', async (e) => {
    PROJECT_ID = e.target.value || null;
    assignTeamBtn.disabled = true;
    if (PROJECT_ID) {
      assignTeamBtn.disabled = assignTeamSelect.value === '';
    }
    await loadProjectData(PROJECT_ID);
    await renderAll();
  });

  // Assign Team Selection Change
  assignTeamSelect.addEventListener('change', () => {
    const projectSelected = selectProject.value !== '';
    const teamSelected = assignTeamSelect.value !== '';
    assignTeamBtn.disabled = !projectSelected || !teamSelected || projectData.isOverall;
  });

  // Assign Button Click
  assignTeamBtn.addEventListener('click', async ()=> {
    const tid = assignTeamSelect.value;
    const pid = selectProject.value; 
    
    if (!pid) { showToast('No project selected to assign team to.', false); return; }
    if (!tid) { showToast('Select a team', false); return; }

    await assignTeamToProject(parseInt(tid), assignRoleInput.value.trim() || 'Contributor', pid);

    assignTeamSelect.value = '';
    assignRoleInput.value = '';
    assignTeamBtn.disabled = true;
  });

  // Tabs
  document.getElementById('tab-project-view').addEventListener('click', ()=> {
    document.getElementById('project-view').classList.remove('hidden');
    document.getElementById('team-management').classList.add('hidden');
    document.getElementById('tab-project-view').classList.add('active');
    document.getElementById('tab-team-management').classList.remove('active');
  });
  document.getElementById('tab-team-management').addEventListener('click', ()=> {
    document.getElementById('project-view').classList.add('hidden');
    document.getElementById('team-management').classList.remove('hidden');
    document.getElementById('tab-project-view').classList.remove('active');
    document.getElementById('tab-team-management').classList.add('active');
  });


  // initial load: attempt a safe sync (non-fatal) then load everything
  try { await safeFetch({ action: 'SYNC_TEAMS_FROM_ASSIGNMENTS' }, 'POST'); } catch (e) { console.warn('Initial sync failed:', e.message); }
  loadAll();

})();
</script>
</body>
</html>